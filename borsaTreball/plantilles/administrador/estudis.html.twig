{% extends "auxiliars/baseDins.html.twig" %}

{% block head %}
    <title>Borsa de treball: Llista d'estudis</title>

    <script>
        function createButton(tipus, classe, text, click) {
            const boto = document.createElement("button");
            boto.type = tipus;
            boto.className = classe;
            boto.appendChild(document.createTextNode(text));
            boto.addEventListener("click", click);
            return boto;
        }

        $(document).ready(function () {
            var dades = {};

            $('#mdResultat').modal({backdrop: 'static', keyboard: false, show: false});
            $('#bmDacord').on('click', function () {
                $('#mdResultat').modal('hide');
            });
            $('#mdEspera').modal({backdrop: 'static', keyboard: false, show: false});
            $('#mEsperaTitol').html('Realitzant les modificacions');
            $('#mdEspera').on('shown.bs.modal', function (e) {
                $.ajax({
                    method: 'DELETE',
                    url: "estudis/" + dades.codi
                }).done(function () {
                    $('#mrTitol').html('Eliminació correcte')
                    $('#mrText').html("<p>S'ha eliminat correctament el cicle.</p>");
                    $('#bmDacord').on('click', function () {
                        $('#mdResultat').modal('hide');
                    });
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'eliminació');
                    $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                    $('#bmDacord').on('click', function () {
                        $('#mdResultat').modal('hide');
                    });
                }).always(function () {
                    $('#mdEspera').modal('hide');
                    $('#mdResultat').modal('show');
                });
            });

            $("#mcTitol").html("Esborrar estudis");
            $("#bcCancelar").on("click", () => {
                $("#mdConfirm").modal("hide");
            })

            $("#bcDacord").on("click", () => {
                $("#mdConfirm").modal("hide");
                $("#mdEspera").modal("show");
            })


            $("#llista").on('change', function () {
                //Recupera professor
                $.ajax({
                    method: 'GET',
                    url: "cicles/" + $("#llista").val()
                }).done(function (cicles) {
                    const mostrador = document.getElementById("mostrador");
                    while (mostrador.lastChild) {
                        mostrador.lastChild.remove();
                    }
                    cicles.forEach(cicle => {
                        console.log(cicle.nom);
                        const div = document.createElement("div");
                        div.classList.add("well");
                        const p = document.createElement("p");
                        p.appendChild(document.createTextNode(cicle.codi + " - " + cicle.nom));
                        div.appendChild(p);

                        const bModifica = createButton("button", "btn btn-primary", "Modificar", () => {
                            document.location = "modificarEstudis?idCicle=" + cicle.codi;
                        });
                        const bEsborra = createButton("button", "btn btn-danger", "Esborra", () => {
                            dades.codi = cicle.codi;
                            $("#mcText").html(`<p>S'eliminarà de l'aplicació el cicle:</p><h5>${cicle.codi} - ${cicle.nom}</h5><p>Sempre que no tengui dades associades.</p>`);
                            $("#mdConfirm").modal("show");
                        });
                        p.appendChild(document.createTextNode(" "));
                        p.appendChild(bModifica);
                        p.appendChild(document.createTextNode(" "));
                        p.appendChild(bEsborra);
                        mostrador.appendChild(div);
                    });
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'eliminació');
                    $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                    $('#bmDacord').on('click', function () {
                        $('#mdResultat').modal('hide');
                    });
                })
            });

        });
    </script>
    <script src="../js/dirtyForms.js"></script>

{% endblock %}

{% block navegacio %}
    {% set actiu=151 %}
    {{ parent() }}
{% endblock %}                     

{% block contingut %}
    <h2>Llista d'estudis</h2>
    <div class="well">
        <div class="row">
            <div class="col-md-8">
                <div class="form-group">
                    <label for="sel1">Families professionals:</label>
                    <div class="input-group">
                        <select class="form-control" id="llista">
                            <option value="">Escull una família professional</option>
                            {% for familia in families %}
                                <option value="{{ familia.id }}">{{ familia.id }} - {{ familia.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="well" id="mostrador">

    </div>
    {{ include('auxiliars/modals.html.twig') }}
{% endblock %}  