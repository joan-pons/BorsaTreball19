{% extends "auxiliars/baseDins.html.twig" %}

{% block head %}
    <title>Borsa de treball: Estudis responsable</title>

    <script>
        $(document).ready(function () {
            var te = new Map();

            {% for tipus in tipusEstudis %}
            te.set({{ tipus.idTipus }}, '{{ tipus.nomTipus }}');
            {% endfor %}

            $('#mdResultat').modal({backdrop: 'static', keyboard: false, show: false});
            $('#bmDacord').on('click', function () {
                $('#mdResultat').modal('hide');
            });
            $('#mdEspera').modal({backdrop: 'static', keyboard: false, show: false});


            $('#bAfegir').on('click', function () {
                $('#mEsperaTitol').html('Afegint els estudis');
                var val = $('#graus').val();
                if (val != "") {
                    $('#mdEspera').on('shown.bs.modal', function (e) {
                        var estudisProfessor = {codiEstudis: val, idProfessor:{{ professor.idProfessor }} };

                        $.ajax({
                            method: 'POST',
                            url: "estudis",
                            data: estudisProfessor
                        }).done(function () {
                            $('#mrTitol').html('Actualització correcte')
                            $('#mrText').html("<p>A partir d'ara rebrà notificacions per validar les ofertes relacionades amb aquests estudis.</p>");
                            $('#bmDacord').on('click', function () {
                                window.location.href = "estudis";
                            });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'actualització');
                            $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                            $('#bmDacord').on('click', function () {
                                $('#mdResultat').modal('hide');
                            });
                        }).always(function () {
                            $('#mdEspera').modal('hide');
                            $('#mdResultat').modal('show');
                        });
                    });
                    $('#mdEspera').modal('show');
                }
            });

            //bEsborrar
            $('.btn-danger').on('click', function (event) {
                $('#mEsperaTitol').html('Esborrant els estudis');
                var val = event.currentTarget.id.replace('b', '')
                $('#mdEspera').on('shown.bs.modal', function (e) {
                    var estudisProfessor = {codiEstudis: val, idProfessor:{{ professor.idProfessor }} };

                    $.ajax({
                        method: 'DELETE',
                        url: "estudis/"+{{ professor.idProfessor }}+"/"+val,
                        data: estudisProfessor
                    }).done(function () {
                        $('#mrTitol').html('Eliminació correcte')
                        $('#mrText').html("<p>A partir d'ara ja no podrà validar ofertes relacionades amb aquests estudis.</p>");
                        $('#bmDacord').on('click', function () {
                            window.location.href = "estudis";
                        });
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'eliminació');
                        $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                        $('#bmDacord').on('click', function () {
                            $('#mdResultat').modal('hide');
                        });
                    }).always(function () {
                        $('#mdEspera').modal('hide');
                        $('#mdResultat').modal('show');
                    });
                });
                $('#mdEspera').modal('show');
            });
            $("#familia").on("change", function () {
                $.ajax({
                    method: 'GET',
                    url: "../cicles/" + $('#familia').val()
                }).done(function (dades) {
                    let opcions = '<option value="">Escull uns estudis</option>';
                    let tipusActual = '';
                    for (cicle of dades) {
                        if (tipusActual != cicle.tipusEstudis) {
                            if (tipusActual !== '') {
                                opcions = opcions + '</optgroup>';
                            }
                            tipusActual = cicle.tipusEstudis;
                            let indicador = te.get(cicle.tipusEstudis);
                            opcions = opcions + '<optgroup label="' + indicador + '">';
                        }
                        opcions = opcions + '<option value="' + cicle.codi + '"> ' + cicle.codi + ' - ' + cicle.nom + '</option>';
                    }
                    opcions = opcions + '</optgroup>';
                    $("#graus").html(opcions);
                });
            });
        });
    </script>
{% endblock %}

{% block navegacio %}
    <ul class="nav navbar-nav">
        <li><a href="modificarDades" id="mActualitza">Actualitzar dades</a></li>
        <li><a href="canviarContrasenya" id="mContrasenya">Canviar contrasenya</a></li>
        {% if professor.actiu %}
            <li class="active"><a>Estudis</a></li>
            {% if not professor.estudis is empty %}
                <li><a href="ofertes">Ofertes</a></li>
            {% endif %}
            {# {% if not alumnes is empty %} #}
            <li><a href="alumnesPendents">Alumnes</a></li>
            {# {% endif %} #}
            <li><a href="empresesPendents">Empreses</a></li>
            {% if usuari.teRol(40) %}
                <li><a href="../administrador/usuaris">Administrador</a></li>
                {# <li><a href="../administrador/obrirAlumnes">Obrir alumnes</a></li> #}
            {% endif %}
        {% endif %}
    </ul>
{% endblock %}

    {% block contingut %}

        {{ include('auxiliars/formEstudisProfessor.html.twig') }}

    {% endblock %}