<h2>Oferta</h2>

<div class='well' id="cont5">
    <form id="fOferta">
        <input type="hidden" name="idEmpresa" value="{{ empresa.idEmpresa }}">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="idOferta">Codi oferta:</label>
                    <input type="text" maxlength="11" class="form-control" id="idOferta" name="idOferta"
                           readonly="readonly" value="{{ oferta.idOferta }}">
                </div>
            </div><!--col-->

        </div><!--row-->
        <div class="row">
            <div class="col-md-12">
                <div class="form-group required">
                    <label for="Titol" class='control-label'>Titol:</label>
                    <input type="text" class="form-control" id="titol" name="titol" value="{{ oferta.titol }}"
                           required="required" maxlength="100">
                </div>
            </div><!--col-->

        </div><!--row-->

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="dPublicacio">Data de publicació:</label>
                    <input type="date" class="form-control" id="dPublicacio" name="dPublicacio" readonly="readonly"
                           title="S'assignarà automàticament en publicar l'oferta" data-toggle="tooltip"
                           value="{{ oferta.dataPublicacio }}">
                </div>
            </div><!--col-->
            <div class="col-md-6">
                <div class="form-group required">
                    <label for="dFinal" class='control-label'>Data finalització:</label>
                    <input type="date" class="form-control" id="dFinal" name="dFinal" readonly="readonly"
                           value="{{ oferta.dataFinal }}" required="required">
                </div>
            </div><!--col-->
        </div><!--row-->

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="tContracte">Tipus de contracte:</label>
                    <input type="text" maxlength="45" class="form-control" id="tContracte" name="tContracte"
                           value="{{ oferta.tipusContracte }}">
                </div>
            </div><!--col-->
            <div class="col-md-6">
                <div class="form-group">
                    <label for="localitat">Localitat:</label>
                    <input type="text" maxlength="60" class="form-control" id="localitat" name="localitat"
                           value="{{ oferta.localitat }}">
                </div>
            </div><!--col-->
        </div><!--row-->

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="horari">Horari:</label>
                    <input type="text" maxlength="60" class="form-control" id="horari" name="horari"
                           value="{{ oferta.horari }}">
                </div>
            </div><!--col-->
        </div><!--row-->

        <div class="row">
            <div class="col-md-9">
                <div class="form-group">
                    <label for="textOferta">Descripció de l'oferta:</label>
                    <div id="textOferta">
                        {{ oferta.descripcio|raw }}
                    </div>
                </div>
            </div><!--col-->
        </div> <!--row-->

        <h3>Estudis als que va dirigida l'oferta</h3>

        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-10">
                        <div class="form-group">
                            <label for="familia">Família professional</label>

                            <select class="form-control" id="familia">
                                <option value="">Escull una família professional</option>
                                {% for familia in families %}
                                    <option value="{{ familia.id }}">{{ familia.nom }} ({{ familia.id }} )</option>
                                {% endfor %}
                            </select>

                        </div>
                    </div>
                </div><!--row-->
                <div class="row">
                    <div class="col-md-10">
                        <div class="form-group">
                            <label for="graus">Estudis oficials disponibles:</label>

                            <select class="form-control" id="graus">
                                <option value="">Escull uns estudis</option>
                                {% for grau in estudis %}
                                    <option value="{{ grau.codi }}">{{ grau.codi }} - {{ grau.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div><!--row-->
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-10">
                        <div class="form-group">
                            <p><label>Estudis seleccionats (Com a mínim n'hi ha d'haver 1):</label></p>
                            <ul id="seleccionats">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div>
                        <button class="btn btn-success" type="submit" id="bEditar">Guardar</button>
                        &nbsp;
                        <button class="btn btn-default" type="reset" id="bSuprimir">Cancel·lar</button>
                    </div>
                </div>
            </div><!--col-->
        </div>
    </form>
</div><!--well-->

{{ include('auxiliars/modals.html.twig') }}

<script src="../js/dirtyForms.js"></script>
<script>
    $(document).ready(function () {

        $('#dFinal').removeAttr("readonly");
        $('#textOferta').summernote({
            height: 150,
            placeholder: "Text de l'oferta",
            toolbar: [
                // [groupName, [list of button]]
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['style', 'ul', 'ol', 'paragraph']],
                ['height', ['height']]
            ]
        });

        $('#fOferta').on('submit', function (event) {
            event.preventDefault();
            var errors = "";
/*            if ($("#nom").val().trim().length < 1) {
                errors += "<p>El camp nom no pot ser buid.</p>";
            }
            if ($("#llinatges").val().trim().length < 1) {
                errors += "<p>El camp Llinatges no pot ser buid.</p>";
            }
            if ($("#email").val().trim().length < 1) {
                errors += "<p>El camp correu electrònic no pot ser buid.</p>";
            }*/
            if(document.getElementsByName('grau').length<1){
                errors+="<p>Al manco ha de seleccionar uns estudis.</p>"
            }
            if (errors === "") {
                $('#mdEspera').modal('show');
            } else {
                $('#mrTitol').html("Atenció!")
                $('#mrText').html(errors);
                $('#mdResultat').modal('show');
            }
        });

        $('#mdResultat').modal({backdrop: 'static', keyboard: false, show: false});
        $('#bmDacord').on('click', function () {
            $('#mdResultat').modal('hide');
        });
        $('#mdEspera').modal({backdrop: 'static', keyboard: false, show: false});
        $('#mEsperaTitol').html('Realitzant les modificacions');
        $('#mdEspera').on('shown.bs.modal', function (e) {
            var oferta = {};
            $.each($('#fOferta [name]'), function (i, obj) {
                oferta[obj.name] = obj.value;
            });
            oferta.estudis = [];
            const graus = document.getElementsByName("grau");
            graus.forEach(grau => {
                oferta.estudis.push({id: grau.value});
            });
            console.log(oferta);
            oferta.descripcio = $('#textOferta').summernote('code');
            {% if oferta is empty %}
            $.ajax({
                method: 'POST',
                url: "afegirOferta",
                data: oferta
            }).done(function (ofertaRebuda) {
                $('#mrTitol').html('Alta correcta')
                $('#mrText').html("<p>L'oferta s'ha donat d'alta correctament.</p>" +
                    "<p>En estar segur que l'oferta és correcta la podreu publicar, un professor la validarà i llavors arribarà als alumnes.</p>");
                $('#bmDacord').on('click', function () {
                    window.location.href = "modificarOferta?idOferta=" + ofertaRebuda.idOferta;
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'alta');
                $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                $('#bmDacord').on('click', function () {
                    $('#mdResultat').modal('hide');
                });
            }).always(function () {
                $('#mdEspera').modal('hide');
                $('#mdResultat').modal('show');
            });
            {% else %}
            $.ajax({
                method: 'PUT',
                url: "modificarOferta/" + oferta.idOferta,
                data: oferta
            }).done(function (ofertaRebuda) {
                $('#mrTitol').html('Modificació correcta')
                $('#mrText').html("<p>L'oferta s'ha modificat correctament.</p>");
                $('#bmDacord').on('click', function () {
                    window.location.href = "modificarOferta?idOferta=" + ofertaRebuda.idOferta;
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                $('#mrTitol').html('<span class="glyphicon glyphicon-alert"></span>&nbsp; Problemes amb l\'alta');
                $('#mrText').html("<p>" + (typeof jqXHR.responseJSON === 'undefined' ? errorThrown : jqXHR.responseJSON.missatge) + "</p>");
                $('#bmDacord').on('click', function () {
                    $('#mdResultat').modal('hide');
                });
            }).always(function () {
                $('#mdEspera').modal('hide');
                $('#mdResultat').modal('show');
            });
            {% endif %}
        });

        var te = new Map();

        {% for tipus in tipusEstudis %}
        te.set({{ tipus.idTipus }}, '{{ tipus.nomTipus }}');
        {% endfor %}



        document.getElementById("familia").addEventListener("change", (e) => {
            const familia = e.target.value;
            if (familia != null && familia != '') {
                fetch(`../cicles/${familia}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(response => response.json())
                    .then(dades => {
                        let opcions = '<option value="">Escull uns estudis</option>';
                        let tipusActual = '';
                        for (let cicle of dades) {
                            if (tipusActual != cicle.tipusEstudis) {
                                if (tipusActual !== '') {
                                    opcions = opcions + '</optgroup>';
                                }
                                tipusActual = cicle.tipusEstudis;
                                let indicador = te.get(cicle.tipusEstudis);

                                opcions = opcions + '<optgroup label="' + indicador + '">';
                            }
                            opcions = opcions + '<option value="' + cicle.codi + '"> ' + cicle.codi + ' - ' + cicle.nom + '</option>';
                        }
                        opcions = opcions + '</optgroup>';
                        $("#graus").html(opcions);
                    })

            }
        });

        function creaEstudi(ul, id, text) {
            const li = document.createElement("li");
            ul.appendChild(li);
            const p = document.createElement("p");
            li.appendChild(p);
            p.appendChild(document.createTextNode(text + " "));
            const boto = document.createElement("button");
            p.appendChild(boto);
            boto.className = "btn btn-xs btn-danger";
            const span = document.createElement("span");
            span.className = "glyphicon glyphicon-trash";
            boto.appendChild(span);
            const input = document.createElement("input");
            input.type = "hidden";
            input.value = id;
            input.name = "grau";
            p.appendChild(input);
            boto.addEventListener("click", (e) => {
                ul.removeChild(e.currentTarget.parentNode.parentNode);
            });
        }

        function jaHiEs(cicle) {
            const graus = document.getElementsByName("grau");
            let trobat = false;
            graus.forEach(grau => {
                if (grau.value === cicle) {
                    trobat = true;
                }
            });
            return trobat;
        }

        document.getElementById("graus").addEventListener("change", (e) => {
            const select = e.target;
            if (select.value != 'null' && !jaHiEs(select.value)) {
                const ul = document.getElementById("seleccionats");
                creaEstudi(ul, select.value, select.options[select.selectedIndex].text);
            }
        });

        const ul = document.getElementById("seleccionats");

        function mostraEstudis() {
            {% for cicle in oferta.estudis %}
            creaEstudi(ul, '{{ cicle.codi }}', '{{ cicle.nom | escape('js') }}');
            {# te.set({{ tipus.idTipus }}, '{{ tipus.nomTipus }}'); #}
            {% endfor %}
        }

        document.getElementById("fOferta").addEventListener("reset", (e) => {
            ul.innerHTML = '';
            mostraEstudis();
        })

        mostraEstudis();
    });
</script>